<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Leoolin">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Leoolin">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="林辰">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Leoolin</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Leoolin</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/" class="post-title-link" itemprop="url">诊断APP的电源和性能回归</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-06-13 20:24:09 / Modified: 22:35:05" itemprop="dateCreated datePublished" datetime="2021-06-13T20:24:09+08:00">2021-06-13</time>
            </span>

          
            <span id="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/" class="post-meta-item leancloud_visitors" data-flag-title="诊断APP的电源和性能回归" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Instruments工具包含了非常丰富的数据，可以自由选择查看各机型、各指标类目的具体性能数据，同样也正因为其展示的数据太过庞杂，可能让开发者不清楚该从如何入手去进行优化。</p>
<p>Xcode 13中Instruments中新增了Regressions模块，它会突出需要优先处理的性能问题，来简化工作流。</p>
<h2 id="Regression"><a href="#Regression" class="headerlink" title="Regression"></a>Regression</h2><p>当一个APP相对与近期的版本，在性能或电量方面发生劣化，就称为回归（Regression）。</p>
<p>比如在上线一个新版本后，APP启动时间增加。</p>
<p><img src="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/1.png" alt="3:47"></p>
<p>最新版本的启动时间，会与近期几个版本的启动时间的平均值进行比较，如果最新版本的启动时间更长，就会标记为回归。</p>
<p><img src="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/2.png" alt="4:33"></p>
<p>Regression左侧栏汇总了哪些指标被回归，以及相较上几个版本劣化了多少。</p>
<ul>
<li><p>Disk Writes</p>
<p>磁盘和内存还有CPU一样都是受限制的资源，不检查磁盘写入会损耗和伤害底层设备，同时还可能造成Hang（用户操作超过250ms未响应记作一个Hang）和UI卡顿，甚至缩短电池寿命。</p>
<ul>
<li>Insights</li>
</ul>
<p>Organzier新增了一个叫做Insights区域的区域，来提供一些性能优化建议</p>
<p><img src="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/4.png" alt="10:29"></p>
</li>
<li><p>File activities</p>
<p>Instruments中的File activities也可以用来debug储存相关的问题。</p>
<p><img src="/2021/06/13/%E8%AF%8A%E6%96%ADAPP%E7%9A%84%E7%94%B5%E6%BA%90%E5%92%8C%E6%80%A7%E8%83%BD%E5%9B%9E%E5%BD%92/3.png" alt="11:40"></p>
</li>
</ul>
<h2 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h2><p><a href>Why is my app getting killed?</a></p>
<p><a href>Triage TestFlight crashes with Xcode Organizer</a></p>
<p><a href>Identify trends with the Power and Performace API</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">检测和诊断内存问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-12 08:58:48" itemprop="dateCreated datePublished" datetime="2021-06-12T08:58:48+08:00">2021-06-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-13 01:36:53" itemprop="dateModified" datetime="2021-06-13T01:36:53+08:00">2021-06-13</time>
              </span>

          
            <span id="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/" class="post-meta-item leancloud_visitors" data-flag-title="检测和诊断内存问题" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>性能是客户端永恒的主题，我们希望用户在使用APP时，能够获得极致的性能体验，关注内存占用也正是因为这一点。<img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/1.png" alt="2:18"></p>
<blockquote>
<p>（温馨提示：本片内容来源自WWDC21：<a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/10180/">Detect and diagnose memory issues</a>）</p>
<p>想了解更多WWDC2021内容的小伙伴，可以阅读我以下文章，欢迎多多交流和指正</p>
<p><a target="_blank" rel="noopener" href="https://gcsnnb.github.io/2021/06/08/What-s-new-in-WWDC21/">一文带你读完WWDC21核心（新）技术点</a></p>
<p><a target="_blank" rel="noopener" href="https://gcsnnb.github.io/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/">APP终极性能生存指南</a></p>
</blockquote>
<ul>
<li><p>Faster application activations</p>
<p>减少APP的内存占用，可以提高APP在后台存活的机会，从而让APP更快的被激活。</p>
<blockquote>
<p>设备的内存空间是有限的，监控APP的内存使用情况，能够防止系统为了回收内存而主动终止APP。</p>
<p>这样即使APP在后台运行，也能够保存当前用户的使用状态，从而避免再次从内存加载导致的耗时。</p>
</blockquote>
</li>
<li><p>Responsive experience</p>
<p>更好的响应速度</p>
<blockquote>
<p>策略性的将APP的内容加载到内存里，能够避免在用户使用APP时，因系统回收内存增加的等待耗时。</p>
</blockquote>
</li>
<li><p>Complex features</p>
<p>让用户体验更丰富的功能</p>
<blockquote>
<p>像加载视频、展示动画，这些复杂的功能往往需要占用更多的内存。因此有策略的使用内存，可以避免在用户使用APP的复杂功能时，被系统因内存占用问题而终止。</p>
</blockquote>
</li>
<li><p>Wider device compatibility</p>
<p>更好的设备兼容性</p>
<blockquote>
<p>让内存空间不太充足的老设备也能更好的使用APP的功能</p>
</blockquote>
</li>
</ul>
<h2 id="内存占用结构"><a href="#内存占用结构" class="headerlink" title="内存占用结构"></a>内存占用结构</h2><p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/2.png" alt="2:26"></p>
<ul>
<li><p>Clean Memory</p>
</li>
<li><p>Dirty Memory</p>
<blockquote>
<p>Clean Memory被分配，并写入内容后成为”脏内存“，脏内存包括：</p>
</blockquote>
<ul>
<li>所有的堆分配（malloc）</li>
<li>解码图像缓冲区</li>
<li>Frameworks</li>
</ul>
</li>
<li><p>Compressed Memory</p>
<blockquote>
<p>压缩内存特指脏页（Dirty Pages）中暂未被访问的部分（Unaccessed pages），会在访问后解压，成为脏内存。</p>
<p>（下文会详细介绍脏页（Dirty Pages）的概念）</p>
</blockquote>
<p>注：iOS中没有内存交换（Memory Swap）的概念，你可能在使用Instrument工具时，见到过<code>Swapped</code>字段，实际上所指的是<code>Compressed Memory</code></p>
</li>
</ul>
<blockquote>
<p>内存占用 = Dirty Memory + Compressed Memory</p>
</blockquote>
<h2 id="内存画像工具"><a href="#内存画像工具" class="headerlink" title="内存画像工具"></a>内存画像工具</h2><p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/3.png" alt="3:52"></p>
<ul>
<li><p>XCTest</p>
<blockquote>
<p>通过单元测试和U测试中的XCTest来检测开发环境的性能指标</p>
</blockquote>
<ul>
<li><p>XCTest可以测量以下性能指标：</p>
<ul>
<li>内存使用情况</li>
<li>CPU使用</li>
<li>磁盘写入情况</li>
<li>卡顿率</li>
<li>执行时间（完成某一任务所花的全部时间）</li>
<li>APP启动时间</li>
</ul>
</li>
<li><p>通过XCTest检测内存使用情况</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testSaveMeal</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">let</span> app = <span class="type">XCUIApplication</span>()</span><br><span class="line">	<span class="keyword">let</span> options = <span class="type">XCTMeasuireOptions</span>()</span><br><span class="line">	options.invocationOptions = [.manullyStart]</span><br><span class="line">	measure(metrics: [<span class="type">XCTMemoryMetric</span>(application: app)],</span><br><span class="line">					options:options) &#123;</span><br><span class="line">		app.launch()</span><br><span class="line">		startMeasureing()</span><br><span class="line">		app.cells.firstMatch.buttons[<span class="string">&quot;Save meal&quot;</span>].firstMatch.tap()</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">let</span> savedButton = app.cells.firstMatch.buttons[<span class="string">&quot;Saved&quot;</span>].firstMatch</span><br><span class="line">		<span class="type">XCTAssertTure</span>(savedButton.waitForExistence(timeout: <span class="number">30</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>XCTest在Xcode 13中新增的两项收集性能情况的诊断产物</p>
<p>开启：<code>enablePerformanceTestsDiagnostics YES</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xcodebuild test</span><br><span class="line">-project MealPannerApp.xcodeproj</span><br><span class="line">-scheme PerformanceTests</span><br><span class="line">-destination platform&#x3D;iOS,name&#x3D;&quot;iPhone&quot;</span><br><span class="line">-enablePerformanceTestsDiagnostics YES</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Ktrace files</p>
<p>Ktrace file能够打开，并展示以下分析报告：</p>
<ul>
<li>当卡顿发生时的渲染通道的状态</li>
<li>因主线程阻塞，导致的Hang（APP无法响应用户的输入或者行为超过250ms，即记作一个hang）</li>
</ul>
</li>
<li><p>Memory graphs</p>
<blockquote>
<p>Memory graph展示APP进程的地址空间的快照</p>
</blockquote>
<p>我们可以生成任务开始（pre_XXX.memgraph）和结束（post_XXX.memgraph）两个时机的内存快照，从而查看这一阶段内存占用的变化。</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/4.png" alt="7:19"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>MetricKit &amp; Xcode Organizer</p>
<p>检测线上环境的内存指标</p>
</li>
</ul>
<h2 id="内存问题"><a href="#内存问题" class="headerlink" title="内存问题"></a>内存问题</h2><ul>
<li><p>内存泄漏（Leaks）</p>
<p>最常见内存泄漏的原因的是循环引用</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/5.png" alt="11:18"></p>
<ul>
<li><p>通过命令行查看memgraph文件</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/6.png" alt="12:28"></p>
</li>
</ul>
</li>
<li><p>堆大小问题（Heap size issues）</p>
<blockquote>
<p>堆是进程地址空间中储存动态分配的对象的段（section），有策略性的加载和释放内存，可以避免内存峰值过高引发OOM。</p>
</blockquote>
<ul>
<li>堆分配回归（Heap allocation regressions）</li>
<li>碎片化（Fragmentation）</li>
</ul>
</li>
</ul>
<h3 id="堆分配回归"><a href="#堆分配回归" class="headerlink" title="堆分配回归"></a>堆分配回归</h3><ul>
<li>使用<code>vmmap -summary</code>对memgraph文件进行分析</li>
</ul>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/7.png" alt="15:31"></p>
<ul>
<li><p>我们主要关心<code>Dirty Size</code>和<code>Swapped Size</code>两列数据</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/8.png" alt="16:09"></p>
</li>
</ul>
<ul>
<li><p>对任务开始（pre_XXX.memgraph）和结束（post_XXX.memgraph）两个时机的内存快照进行对比</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/9.png" alt="16:42"></p>
</li>
<li><p>可以在下方看到按类聚合的，各类对象占用内存的大小</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/10.png" alt="17:15"></p>
<p>从图中可以看到，<code>non-object</code>类型的数据，占用内存约13M。在Swift中，<code>non-object</code>通常代表原始分配字节（raw malloced bytes）</p>
</li>
<li><p>打印memgraph文件中，类型为<code>non-object</code>且占用内存超过500k的对象</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/11.png" alt="17:36"></p>
</li>
<li><p>打印对象的引用树</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/12.png" alt="18:00"></p>
</li>
<li><p>可以通过<code>malloc_history -fullStacks</code>打印对象的分配调用栈</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/13.png" alt="19:42"></p>
</li>
<li><p>当不确定是哪个对象有问题时，可以通过<code>leaks --referenceTree</code>，自顶向下打印进程的所有内存中最可疑的对象</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/14.png" alt="18:40"></p>
<ul>
<li>可以通过<code>--groupByType</code>参数，按type聚合简化打印结果。</li>
</ul>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/15.png" alt="19:08"></p>
</li>
</ul>
<h3 id="碎片化"><a href="#碎片化" class="headerlink" title="碎片化"></a>碎片化</h3><blockquote>
<p>先介绍两个概念：页和”脏页“</p>
<ul>
<li>页（Pages）：是最小的独立的内存单元</li>
<li>一旦页中写入任何数据，都会使整页变成”脏页“</li>
</ul>
</blockquote>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/16.png" alt="21:37"></p>
<p>当内存准备写入新的数据时，系统会优先尝试使用脏页中的空闲内存，而当即将分配的内存过大时，即使空闲内存的总大小足够，但其并不是一段连续的内存空间，仍会开辟一个新的脏页去写入这些数据。</p>
<p>这些无法被使用的空闲内存就是”碎片化内存“</p>
<p>再例如以下这种情况：我们分配的对象总共使用了4个页，但每个页的占用空间只占50%。</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/25.png" alt="23:19"></p>
<p>当我们释放这些对象后，这些4个脏页的内存空间仍有50%的碎片化内存。</p>
<p>最理想化的状态应该将所有的分配的对象放在两页，如下图：</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/18.png" alt="23:42"></p>
<p>这样一旦释放这些对象时，仅会留有两个脏页，并且不存在碎片化内存。</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/19.png" alt="23:52"></p>
<ul>
<li><p>我们的目标：</p>
<ul>
<li>让分配的对象尽可能连续且拥有同样的生命周期</li>
<li>碎片化率保持在25%以下</li>
<li>使用自动释放池</li>
<li>特别注意长时间运行的进程</li>
</ul>
</li>
<li><p><code>vmman -summary xx.memgraph</code>查看碎片化内存情况</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/20.png" alt="25:00"></p>
<ul>
<li><p>DefaultMallocZone</p>
<p>平时开发者只需要关注这部分的内存空间，因为这是我们进行堆分配默认结束的地方</p>
</li>
<li><p>MallocStackLoggingLiteZone</p>
<p>这个空间是所有堆分配结束的地方</p>
</li>
</ul>
</li>
<li><p>使用Instruments工具中的Allocations track查看内存情况</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/21.png" alt="26:41"></p>
<p>其中的Destroyed和Persisted分别对应上面所描述的内存释放后的空闲内存（free memory）和仍未释放的内存（remaining objects）</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/22.png" alt="26:42"></p>
</li>
</ul>
<p>回顾下我们的总体排查流程：</p>
<p><img src="/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/23.png" alt="27:51"> </p>
<h2 id="更多WWDC有关性能的Session"><a href="#更多WWDC有关性能的Session" class="headerlink" title="更多WWDC有关性能的Session"></a>更多WWDC有关性能的Session</h2><p><a href>iOS memory deep dive WWDC18</a></p>
<p><a href>Getting started with Instruments WWDC19</a></p>
<p><a href>Understand and eliminate hangs from your apps WWDC21</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">APP终极性能生存指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-09 22:24:39" itemprop="dateCreated datePublished" datetime="2021-06-09T22:24:39+08:00">2021-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-13 01:05:13" itemprop="dateModified" datetime="2021-06-13T01:05:13+08:00">2021-06-13</time>
              </span>

          
            <span id="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/" class="post-meta-item leancloud_visitors" data-flag-title="APP终极性能生存指南" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>性能是客户端永远绕不开的话题，一起来康康今年的WWDC提供了哪些有关性能提升的建议吧~</p>
<blockquote>
<p>（温馨提示：本片内容来源自WWDC21：<a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/10181/">Ultimate application performance survival guide</a>）</p>
<p>想了解更多WWDC2021内容的小伙伴，可以阅读我以下文章，欢迎多多交流和指正</p>
<p><a target="_blank" rel="noopener" href="https://gcsnnb.github.io/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/">检测和诊断内存问题</a></p>
<p><a target="_blank" rel="noopener" href="https://gcsnnb.github.io/2021/06/08/What-s-new-in-WWDC21/">一文带你读完WWDC21核心（新）技术点</a></p>
</blockquote>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/24.png" alt="1:38"></p>
<ul>
<li><p>使用的五种工具</p>
<ul>
<li>Xcode Organizer</li>
<li>MetricKit</li>
<li>Instruments</li>
<li>XCTest</li>
<li>App Store Connect API</li>
</ul>
</li>
<li><p>参考的八个性能指标</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/2.png" alt="1:58"></p>
<ul>
<li><p>电量</p>
</li>
<li><p>启动时间</p>
</li>
<li><p>超时响应率（Hang rate）</p>
<blockquote>
<p>APP无法响应用户的输入或者行为超过250ms，即记作一个hang</p>
</blockquote>
</li>
<li><p>内存</p>
</li>
<li><p>磁盘写入</p>
</li>
<li><p>滚动卡顿</p>
</li>
<li><p>APP终止</p>
</li>
<li><p>MXSignposts</p>
</li>
</ul>
</li>
<li><p>电量（battery usage）</p>
<ul>
<li><p>优化电池使用需要关注的几点：</p>
<ul>
<li>CPU</li>
<li>网络</li>
<li>定位</li>
<li>音频</li>
<li>蓝牙</li>
<li>GPU</li>
</ul>
<blockquote>
<p>其中CPU、网络、定位是电量消耗大户</p>
</blockquote>
</li>
<li><p>使用Xcode工具查看Debug期间的电量损耗情况</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/4.png" alt="4:10"></p>
<ul>
<li>查看CPU超过20%的阶段（CPU High Utilization）</li>
<li>查看CPU从闲置被唤醒的阶段（CPU Wake Overhead）</li>
</ul>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/5.png" alt="4:41"></p>
</li>
<li><p>使用Instrument中的Time Profile工具查看该阶段更详细的信息</p>
<p>（比如使用Location Energy Model确保应用如预期中正确地使用定位功能）</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/6.png" alt="这张是我本地截屏"></p>
</li>
<li><p>使用MetricKit收集用户的性能数据</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/7.png" alt="6:41"></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建遵守`MXMetricManagerSubscriber`的协议的类AppMetrics</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AppMetrics</span>: <span class="title">MXMetricManagerSubscriber</span> </span>&#123;</span><br><span class="line">	<span class="keyword">init</span>() &#123;</span><br><span class="line">  		<span class="comment">// 初始化时将AppMetrics加入到`MXMetricManager`单例中</span></span><br><span class="line">  		<span class="keyword">let</span> shared = <span class="type">MXMetricManager</span>.shared</span><br><span class="line">  		shared.add(<span class="keyword">self</span>)</span><br><span class="line">  	&#125;</span><br><span class="line">  	<span class="keyword">deinit</span> &#123;</span><br><span class="line">  		<span class="comment">// 销毁时进行移除</span></span><br><span class="line">  		<span class="keyword">let</span> shared = <span class="type">MXMetricManager</span>.shared</span><br><span class="line">  		shared.remove(<span class="keyword">self</span>)</span><br><span class="line">  	&#125;</span><br><span class="line">  	</span><br><span class="line">    <span class="comment">// 处理每日的metrics</span></span><br><span class="line">  	<span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> payloads: [MXMetricPayload])</span></span> &#123;</span><br><span class="line">  	</span><br><span class="line">  	&#125;</span><br><span class="line">  	</span><br><span class="line">    <span class="comment">// 处理diagnostics</span></span><br><span class="line">  	<span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> payloads: [MXDiagnositcPayload])</span></span> &#123;</span><br><span class="line">  	</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
<ul>
<li><p>使用Xcode Organizer查看线上性能数据</p>
<blockquote>
<p>Xcode Organizer对MetrixKit收集到的数据进行了聚合，忽略了单一用户的详细数据，展现的是整体的趋势；</p>
<p>而使用MetricKit可以更具针对性的对某一用户在一段时间内的性能表现进行分析。</p>
</blockquote>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/8.png" alt="6:57"></p>
<ul>
<li>查看用户的电量使用情况</li>
</ul>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/9.png" alt="7:03"></p>
<ul>
<li><p>Regressions</p>
<blockquote>
<p>Regressions是Xcode 13新增的模块，它将各个版本的性能指标中发生劣化的情况单独拎出来展示，让开发者更清晰的看到哪些性能指标亟待优化。</p>
</blockquote>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/10.png" alt="7:22"></p>
</li>
<li><p>查看问题发生时对应的代码</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/11.png" alt="7:58"></p>
</li>
</ul>
</li>
<li><p>超时响应率和滚动卡顿（Hang rate &amp; Scrolling）</p>
<ul>
<li><p>超时响应</p>
<p>长时间无法响应是导致用户强退应用的重要原因</p>
</li>
<li><p>滚动卡顿</p>
<p>当在下一次屏幕刷新时，新的内容还未ready就会出现卡顿</p>
</li>
</ul>
<blockquote>
<p>Hang rate &amp; Scrollings是表明APP没有及时响应的两个指标,一旦发生会严重影响用户体验，甚至让用户在使用应用时产生挫败感，从而降低用户的使用APP的意愿。</p>
</blockquote>
<ul>
<li><p>使用Xcode Organizer查看线上的卡顿情况</p>
<ul>
<li>Hang rate</li>
</ul>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/12.png" alt="9:40"></p>
<ul>
<li>Scrolling</li>
</ul>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/13.png" alt="9:42"></p>
</li>
<li><p>使用Instrument进行分析</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/14.png" alt="10:05"></p>
<ul>
<li><p>Thread State Trace</p>
<p>可以查看线程被阻塞的详细情况</p>
</li>
<li><p>System Call Trace</p>
<p>可以查看系统函数调用的时机和时长</p>
</li>
</ul>
</li>
<li><p>使用XCTest进行性能测试</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testScrollingAnimationPerformance</span><span class="params">()</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">	app.launch()</span><br><span class="line">	app.staticTexts[<span class="string">&quot;Meal Planner&quot;</span>].tap()</span><br><span class="line">	<span class="keyword">let</span> foodCollection = app.collectionViews.firstMatch</span><br><span class="line">	<span class="comment">// `measure`函数默认重复5次，可以通过option设置手动停止</span></span><br><span class="line">	<span class="keyword">let</span> measureOptions = <span class="type">XCTMeasureOptions</span>()</span><br><span class="line">	measureOptions.invocationOptions = [.manuallyStop]</span><br><span class="line">	<span class="comment">// 开始measure</span></span><br><span class="line">	measure(metrics: [<span class="type">XCTOSSignpostMetric</span>.scrollDecelerationMetric], </span><br><span class="line">	option: measureOptions) &#123;</span><br><span class="line">    <span class="comment">// 滑动</span></span><br><span class="line">		foodCollection.swipeUP(velocity: .fast)</span><br><span class="line">    <span class="comment">// 停止measure</span></span><br><span class="line">		stopMeasuring()</span><br><span class="line">    <span class="comment">// 重置状态</span></span><br><span class="line">		foodCollection.swipeDown(velocity: .fast)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用MetricKit收集线上数据</p>
<blockquote>
<p>在iOS 14中，MetricKit会收集用户使用过程中发生的问题，然后每24小时集中上报一次。</p>
<p>在iOS 15和MacOS 12中，MetricKit会在用户发生问题后，并且立刻进行上报</p>
</blockquote>
</li>
<li><p>iOS 15中MetricKit新增动画性能检测的API，能够记录动画期间详细的性能数据和卡顿情况</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startAnimating</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="comment">// 标记动画开始执行</span></span><br><span class="line"> mxSignpostAnimaitionIntervalBegin(</span><br><span class="line"> 	log: <span class="type">MXMetricManager</span>.makeLogHandle(category: <span class="string">&quot;animation&quot;</span>_telemetry),</span><br><span class="line"> 	name: <span class="string">&quot;custom_animation&quot;</span>)</span><br><span class="line"> )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">animationDidComplete</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// 标记动画结束</span></span><br><span class="line">	mxSignpost(<span class="type">OSSignpostType</span>.end, log: <span class="type">MXMetricManager</span>.makeLogHandle(category: <span class="string">&quot;animation_telemetry&quot;</span>), name: <span class="string">&quot;custom_animation&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">  &gt; 注：MXSignpost是MetricKit中封装的API，可以用来监控关键代码的运行情况</span><br><span class="line"></span><br><span class="line">![11:20](APP性能终极生存指南&#x2F;15.png)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>磁盘写入</p>
<ul>
<li><p>使用Instrument中的File Activity查看磁盘写入情况</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/16.png" alt="13:22"></p>
<ul>
<li><p>优化建议：</p>
<ul>
<li><p>对于频繁写入的case，推荐使用Core Data</p>
</li>
<li><p>避免快速创建和删除文件</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>使用XCTest进行性能测试</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testSaveMeal</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">let</span> app = <span class="type">XCUIApplication</span>()</span><br><span class="line">	<span class="keyword">let</span> options = <span class="type">XCTMeasureOptions</span>()</span><br><span class="line">	options.invocationOptions = [.manullyStart]</span><br><span class="line">	<span class="comment">// 检测下面代码运行时的磁盘写入情况</span></span><br><span class="line">	measure(metrics: [<span class="type">XCTStorageMetric</span>(application: app)], options: options) &#123;</span><br><span class="line">	app.launch()</span><br><span class="line">	startMeasuring()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">let</span> firstCell = app.cells.firstMatch</span><br><span class="line">	firstCell.buttons[<span class="string">&quot;Save meal&quot;</span>].firstMatch.tap()</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">let</span> savedButton = firstCell.buttons[<span class="string">&quot;Saved&quot;</span>].firshMatch</span><br><span class="line">	<span class="type">XCTAssertTure</span>(savedButton.waitForExistence(timeout: <span class="number">2</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用Xcode Organizer查看线上磁盘写入情况</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/17.png" alt="14:35"></p>
<ul>
<li>查看在Disk Writes报告中可以查看24小时内写入量超过1GB的case</li>
</ul>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/18.png" alt="15:01"></p>
<ul>
<li>在Xcode 13中，还可以得到一些优化建议</li>
</ul>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/19.png" alt="15:22"></p>
</li>
<li><p>使用MetricKit收集用户的磁盘写入情况</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标记开始磁盘写入</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">syncAllContentsToDB</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mxSignpost(<span class="type">OSSignpostType</span>.begin, </span><br><span class="line">	log:<span class="type">MXMetricManager</span>.makeLogHandle(categroy: <span class="string">&quot;diskWrite_telemetry&quot;</span>),</span><br><span class="line">	name: <span class="string">&quot;custom_diskWrites&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// sync contents to database</span></span><br><span class="line">	</span><br><span class="line">  <span class="comment">// 标记磁盘写入结束</span></span><br><span class="line">	mxSignpost(<span class="type">OSSignpostType</span>.end,</span><br><span class="line">	log:<span class="type">MXMetricManager</span>.makeLogHandle(category: <span class="string">&quot;diskWrite_telemetry&quot;</span>),</span><br><span class="line">	name: <span class="string">&quot;custom_diskWrites&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>启动时间</p>
<ul>
<li><p>使用Xcode Organizer查看线上启动数据</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/20.png" alt="18:15"></p>
<ul>
<li>查看因启动超时导致的程序终止</li>
</ul>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/21.png" alt="18:47"></p>
</li>
<li><p>使用Instrument中的App Launch工具进一步分析</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/22.png" alt="19:13"></p>
</li>
</ul>
</li>
<li><p>Memory</p>
<ul>
<li><p>使用Xcode Organizer查看线上内存使用情况</p>
<p><img src="/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/23.png" alt="20:21"></p>
</li>
<li><p>使用Instrument中的Leak、Allocations和VM Tracker三个模板</p>
<ul>
<li>Leak检测内存泄漏</li>
<li>Allocations分析内存的生命周期</li>
<li>VM Tracker展示虚拟内存空间的使用情况</li>
</ul>
</li>
<li><p>使用MetricKit收集线上数据</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveAppAssets</span><span class="params">()</span></span> &#123;</span><br><span class="line">	mxSignpost(<span class="type">OSSignpostType</span>.begin, </span><br><span class="line">	log: <span class="type">MXMetricManager</span>.makeLogHandle(category: <span class="string">&quot;memory_telemetry&quot;</span>),</span><br><span class="line">	name: <span class="string">&quot;custom_memory&quot;</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// save app metadata</span></span><br><span class="line">	</span><br><span class="line">	mxSignpost(<span class="type">OSSignpostType</span>.end,</span><br><span class="line">	log: <span class="type">MXMetricManger</span>.makeLogHandle(category: <span class="string">&quot;memory_telemetry&quot;</span>),</span><br><span class="line">	name: <span class="string">&quot;custom_memory&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ul>
<p>更多有关电量优化的Session：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2019/417/">Improving battery life and performance WWDC19</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/10212/">Analyze HTTP traffic in Instruments WWDC 21</a></p>
<p>更多Hang优化的Session：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/10258/">Understand and Eliminate Hangs from you app WWDC21</a></p>
<p>更多滚动优化的Session：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/tech-talks/10855/">Explore UI animation hitches and the render loop WWDC20</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2020/10077/">Eliminate animation hitches with XCTest WWDC20</a></p>
<p>更多磁盘写入优化的Session：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/10087/">Diagnose power and performance regressions in your app WWDC21</a></p>
<p>更多启动优化的Session：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2020/10078/">Why is my app getting killed WWDC20</a></p>
<p>更多内存优化的Session：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/10180/">Detect and diagnose memory issues</a></p>
<p>更多关于性能工具的Session：</p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2020/10076/">Diagnose performance issues with Xcode Organizer WWDC20</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2020/10081/">What’s new in MetricKit WWDC20</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2020/10057/">Identify trends with Power and Performance API WWDC20</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2019/411/">Getting started with Instruments WWDC19</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/08/What-s-new-in-WWDC21/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/08/What-s-new-in-WWDC21/" class="post-title-link" itemprop="url">一文带你读完WWDC21核心（新）技术点</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-08 00:49:29" itemprop="dateCreated datePublished" datetime="2021-06-08T00:49:29+08:00">2021-06-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-13 01:06:16" itemprop="dateModified" datetime="2021-06-13T01:06:16+08:00">2021-06-13</time>
              </span>

          
            <span id="/2021/06/08/What-s-new-in-WWDC21/" class="post-meta-item leancloud_visitors" data-flag-title="一文带你读完WWDC21核心（新）技术点" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/08/What-s-new-in-WWDC21/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/08/What-s-new-in-WWDC21/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一年一度的WWDC又来了，一起来看看今年又有哪些值得关注的技术点吧~</p>
<blockquote>
<p>（温馨提示：本片内容来源自WWDC21：<a target="_blank" rel="noopener" href="https://developer.apple.com/videos/play/wwdc2021/102/">Platforms State of the Union</a>）</p>
<p>想了解更多WWDC2021内容的小伙伴，可以阅读我以下文章，欢迎多多交流和指正</p>
<p><a target="_blank" rel="noopener" href="https://gcsnnb.github.io/2021/06/12/WWDC21-%E6%A3%80%E6%B5%8B%E5%92%8C%E8%AF%8A%E6%96%AD%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98/">检测和诊断内存问题</a></p>
<p><a target="_blank" rel="noopener" href="https://gcsnnb.github.io/2021/06/09/APP%E6%80%A7%E8%83%BD%E7%BB%88%E6%9E%81%E7%94%9F%E5%AD%98%E6%8C%87%E5%8D%97/">APP终极性能生存指南</a></p>
</blockquote>
<h2 id="Xcode-Cloud"><a href="#Xcode-Cloud" class="headerlink" title="Xcode Cloud"></a>Xcode Cloud</h2><blockquote>
<p>试想一个一站式的iOS开发体验，在Xcode中提交代码后，自动在云端编译并且测试，接下来开发者只需根据Xcode上显示的测试结果改进代码，当一切准备就绪，就会自动将应用分发到各平台的TestFlight中…，为了实现这样流畅的开发体验，Apple将开发流程中所涉及到的所有环节，都集成到了Xcode中。</p>
<p><strong>温馨提示：Xcode Clould目前限时免费，大家可以在<a target="_blank" rel="noopener" href="https://developer.apple.com/xcode-cloud/">官网</a>申请Beta版权限</strong></p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/1.png" alt="截屏2021-06-08 下午9.53.50"></p>
</blockquote>
<ul>
<li><p>原有的开发流程</p>
<ul>
<li><p>各个环节</p>
<p>Coding -&gt; 测试 -&gt; 整合 -&gt; 分发 -&gt; 改进</p>
<blockquote>
<p>这里的整合指的是功能分支合到主干分支的过程。</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/2.png" alt="截屏2021-06-09 上午7.25.41"></p>
</li>
<li><p>痛点</p>
<p>每个环节依赖不同的工具，而环境切换的过程往往会中断我们编写代码的思路</p>
</li>
</ul>
</li>
<li><p>Xcode Cloud</p>
<blockquote>
<p>一个负责持续集成和分发服务的工具</p>
</blockquote>
<ul>
<li><p>优势：</p>
<ul>
<li>内置在Xcode，无需切换工作上下文；</li>
<li>提交Commit后，自动在云端编译；</li>
<li>灵活且可扩展，支持集成其他CI系统；</li>
<li>数据安全，保证源码、密钥安全。</li>
</ul>
</li>
<li><p>工作流：</p>
<ul>
<li><p>选中项目</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/3.png" alt="截屏2021-06-09 上午7.39.33"></p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/4.png" alt="截屏2021-06-09 上午7.39.01"></p>
</li>
<li><p>确认工作流</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/5.png" alt="截屏2021-06-09 上午7.40.22"></p>
</li>
<li><p>授权访问源代码</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/6.png" alt="截屏2021-06-09 上午7.42.25"></p>
</li>
<li><p>连接App Store Connect</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/7.png" alt="截屏2021-06-09 上午7.41.50"></p>
</li>
<li><p>查看结果</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/8.png" alt="截屏2021-06-09 上午7.43.28"></p>
<ul>
<li><p>左侧导航器会根据项目的分支名进行分组</p>
</li>
<li><p>右侧详情页会显示所有动作的状态</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/9.png" alt="截屏2021-06-09 上午7.44.35"></p>
</li>
</ul>
</li>
<li><p>增加新的工作流</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/10.png" alt="截屏2021-06-09 上午7.45.54"></p>
<ul>
<li><p>设置触发编译的条件</p>
<ul>
<li><p>方案一：分支上每次代码变更时触发</p>
</li>
<li><p>方案二：Pull Request分支上每次代码变更时触发</p>
</li>
<li><p>方案三：对标签（Tag）进行修改时触发</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/11.png" alt="截屏2021-06-09 上午7.52.36"></p>
</li>
</ul>
</li>
<li><p>选择Xcode的版本</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/12.png" alt="截屏2021-06-09 上午7.52.36"></p>
</li>
<li><p>添加Action</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/13.png" alt="截屏2021-06-09 上午7.54.36"></p>
<ul>
<li><p>添加UI Test</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/14.png" alt="截屏2021-06-09 上午7.55.14"></p>
</li>
</ul>
</li>
<li><p>查看Action运行结果</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/15.png" alt="截屏2021-06-09 上午7.57.03"></p>
<ul>
<li><p>可以使用Xcode Cloud通过UI Test过程中的截屏查看运行过程</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/16.png" alt="截屏2021-06-09 上午7.57.37"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>分支整合</p>
<ul>
<li><p>在Xcode中管理Pull Request</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/17.png" alt="截屏2021-06-09 上午7.58.36"></p>
</li>
<li><p>在当前编译的条件下，Xcode Cloud会自动构建和测试所有Pull Merge分支上的新Commit</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/32.png" alt="截屏2021-06-09 上午8.00.04"></p>
</li>
<li><p>还可以快速定位至评论中所涉及到的代码位置</p>
<blockquote>
<p>点击左侧栏中带有信息标识的类名，点击可以直接定位到对应的位置，并查看评论</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/18.png" alt="截屏2021-06-09 上午8.01.48"></p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/19.png" alt="截屏2021-06-09 上午8.03.02"></p>
</li>
</ul>
</li>
<li><p>分发</p>
<ul>
<li><p>云端自动签名</p>
<blockquote>
<p>开发者无需关心描述文件和密钥等事项</p>
</blockquote>
</li>
<li><p>支持多平台 TestFlight自动分发（包括Mac版）</p>
</li>
</ul>
</li>
<li><p>改进</p>
<ul>
<li><p>在测试过程中，Xcode Organizer可以在几分钟内收到TestFlight用户的反馈信息，开发者可以根据用户描述的信息对代码进行改进</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/20.png" alt="截屏2021-06-09 上午8.04.24"></p>
</li>
</ul>
</li>
</ul>
<h2 id="Swift"><a href="#Swift" class="headerlink" title="Swift"></a>Swift</h2><h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><ul>
<li><p>理解asymc/await</p>
<blockquote>
<p>await表示当前调用者正在等待异步函数的结果</p>
</blockquote>
<p>比如：完成一次舞蹈演出需要三个 <strong>异步步骤</strong>：演员热身、工作人员从仓库找出道具、搭建舞台，完成这些演员才可以登台演出。</p>
<ul>
<li><p>原有嵌套式写法（伪代码）：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareForShow</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 演员热身</span></span><br><span class="line">	danceCompany.warmUp &#123;</span><br><span class="line">    <span class="comment">// 工作人员从仓库找出道具</span></span><br><span class="line">		 <span class="keyword">self</span>.crew.fetchStageScenery &#123;</span><br><span class="line">        <span class="comment">// 搭建舞台</span></span><br><span class="line">		 		<span class="keyword">self</span>.setStage &#123;</span><br><span class="line">          <span class="comment">// 登场演出</span></span><br><span class="line">		 		  dancers.moveToPosition</span><br><span class="line">		 		&#125;</span><br><span class="line">		 &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用async/await的直线排列式写法：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareForShow</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Scene</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> dancers = <span class="keyword">try</span> await danceCompany.warmUP(duration: .minutes(<span class="number">45</span>))</span><br><span class="line">	<span class="keyword">let</span> scenery = await crew.fetchStageScenery()</span><br><span class="line">	<span class="keyword">let</span> openingScene = setStage(with: scenery)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">try</span> await dancers.moveToPosition(<span class="keyword">in</span>: openingScence)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>结构化并发（Structured concurrency）</p>
<p>再比如：完成一次舞蹈演出需要三个 <strong>异步步骤</strong>：演员热身、工作人员从仓库找出道具、搭建舞台，完成这些演员才可以登台演出。其中<strong>演员热身</strong>和<strong>工作人员从仓库找出道具、搭建舞台</strong>可以同时进行</p>
<ul>
<li><p>创建并发子任务</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">prepareForShow</span><span class="params">()</span></span> async <span class="keyword">throws</span> -&gt; <span class="type">Scene</span> &#123;</span><br><span class="line">	async <span class="keyword">let</span> dancers = <span class="keyword">try</span> await danceCompany.warmUP(duration: .minutes(<span class="number">45</span>))</span><br><span class="line">	async <span class="keyword">let</span> scenery = await crew.fetchStageScenery()</span><br><span class="line">	<span class="keyword">let</span> openingScene = setStage(with: await scenery)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">try</span> await dancers.moveToPosition(<span class="keyword">in</span>: openingScence)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>actors</p>
<ul>
<li><p>actor</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">actor <span class="type">StageManager</span> &#123;</span><br><span class="line">    	<span class="keyword">var</span> stage: <span class="type">Stage</span></span><br><span class="line">    	</span><br><span class="line">    	<span class="function"><span class="keyword">func</span> <span class="title">setStage</span><span class="params">(with scenery: Scenery)</span></span> -&gt; <span class="type">Scene</span> &#123;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以前通过串行dispatch queue进行属性互斥访问的方式，由于需要管理很多冗余代码，很容易引入额外的竞争机制，从而出现问题， 而将actor作为一级构造嵌入到Swift里，可以底层设计层面避免了这种情况的发生。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>MainActor</p>
<blockquote>
<p>函数会同步到主线程执行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@MainActor</span><br><span class="line">func display(scene: Scene)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>小结：async/await让异步代码写的更自然，结构化并发让代码更容易理解，actors用来构建安全的共享状态</p>
<h3 id="Swift-Playgrounds"><a href="#Swift-Playgrounds" class="headerlink" title="Swift Playgrounds"></a>Swift Playgrounds</h3><blockquote>
<p>现在在iPad上也能用Swift Playgrounds开发app了</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/21.png" alt="截屏2021-06-09 上午8.10.55"></p>
<ul>
<li><p>在iPad上可以直接发布应用到TestFlight</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/22.png" alt="截屏2021-06-09 上午8.12.18"></p>
</li>
</ul>
<h3 id="Focus"><a href="#Focus" class="headerlink" title="Focus"></a>Focus</h3><ul>
<li><p>通知</p>
<blockquote>
<p>原有的通知无论优先级如何，都会以相同的方式堆积在我们的屏幕上，完全看不出哪一条通知更重要</p>
</blockquote>
<ul>
<li><p>现在通知可以归类成四类干扰等级</p>
<ul>
<li><p>Passive</p>
<p>无声且不会唤醒设备，下一次拿起手机时显示，用于时效性不强的通知</p>
</li>
<li><p>Active（同之前默认的通知类型）</p>
<p>带有音效和触感反馈，同以往的通知一样</p>
</li>
<li><p>Time Sensitive</p>
<p>这一等级的通知会马上推送给用户，用户不点击会停留在锁屏页上一段时间，用于马上需要读取的通知</p>
</li>
<li><p>Critical</p>
<p>即使设备静音，也会播放声效，只有关系到健康和安全的重大通知，才能设置成这一等级，且设置时需要用户授权</p>
</li>
</ul>
<p>除此之外，还有一种特别的通知：</p>
<ul>
<li><p>消息类型通知（信息或者通话）</p>
<blockquote>
<p>如果你开发的是通信类APP，可以告诉系统，这是消息或者通话类型的通知，系统会自动调整通知的样式和运行方式，以便人们更好的查看消息</p>
</blockquote>
</li>
</ul>
</li>
<li><p>通知摘要</p>
<blockquote>
<p>为了避免人们错过一些通知，同时帮助用户能在自己想要的时间查看通知，系统提供了一种新的通知展示样式 — <strong>通知摘要</strong>，用户可以使用通知摘要，在选择的时间来集中查看推送</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/23.png" alt="截屏2021-06-09 上午8.26.35"></p>
<ul>
<li><p>消息类型：只展示Passive或Active类型的通知</p>
</li>
<li><p>通知摘要的顶部有两个轮播位置</p>
<ul>
<li>轮播位通知选取规则：<ul>
<li>带有大缩略图的通知会比没有大缩略图的通知，优先入选</li>
<li>默认情况：推送最多的APP会优先得到推荐，当然用户可以在此基础上个性化定制摘要</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>等级调整</p>
<blockquote>
<p>系统根据用户和APP通知的交互行为，推荐用户将其调整为合适的干扰等级</p>
</blockquote>
<ul>
<li><p>如果用户经常在专注模式使用某APP</p>
<blockquote>
<p>系统会建议将该APP调整为专注模式时允许接收通知</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/24.png" alt="截屏2021-06-09 上午8.27.35"></p>
</li>
<li><p>如果用户经常与某APP的Time Sensitive通知进行交互</p>
<blockquote>
<p>系统会建议将改APP的通知等级调回为Active</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/25.png" alt="截屏2021-06-09 上午8.30.33"></p>
</li>
<li><p>如果某APP不断发送通知，用户却没有反应</p>
<blockquote>
<p>系统会建议将这个APP发送的通知静音</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/26.png" alt="截屏2021-06-09 上午8.33.44"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>小结</p>
<ul>
<li>通过设置通知相关性分数和合适的缩略图，使通知占据摘要顶部的轮播位置</li>
<li>思考APP的通知最适合哪一干扰级别<ul>
<li>例如：如果是聊天软件，应该使用最新的<code>User Notifications API</code>来告诉系统来自APP的消息和来电通知</li>
</ul>
</li>
<li>使用最新的<code>Focus Status API</code>，在APP里显示用户的专注模式状态</li>
</ul>
</li>
</ul>
<h3 id="Widget"><a href="#Widget" class="headerlink" title="Widget"></a>Widget</h3><blockquote>
<p>通过Widget的新特性让你的APP更好用、且更容易被用户看到</p>
</blockquote>
<ul>
<li><p>使用iPad上的超大尺寸小组件</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/27.png" alt="截屏2021-06-09 上午8.34.23"></p>
</li>
<li><p>通过Intents框架让Widget自动加入到智能堆叠小组件中</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/28.png" alt="截屏2021-06-09 上午8.35.14"></p>
</li>
</ul>
<h3 id="SharePlay"><a href="#SharePlay" class="headerlink" title="SharePlay"></a>SharePlay</h3><blockquote>
<p>人们聚会时，除了聊天以外，分享体验也很重要，SharePlay Kit的出现正是为了帮助人们在难以相见的时候，依旧保持紧密联系。</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/29.png" alt="截屏2021-06-09 上午8.36.35"></p>
<ul>
<li><p>入口</p>
<ul>
<li>FaceTime</li>
<li>iMessage</li>
</ul>
<blockquote>
<p>让人们在视频聊天的同时，共同进行一项活动，比如：共享视频播放、共享画布。</p>
</blockquote>
</li>
<li><p>共享视频播放</p>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/30.png" alt="截屏2021-06-09 上午8.37.18"></p>
</li>
</ul>
<blockquote>
<p>在视频APP里采用Group Activities和AVPlayer同步，从而可以快速集成这一功能。</p>
</blockquote>
<ul>
<li><p>共享画布</p>
<blockquote>
<p>基于Group Activities，将笔画发给FaceTime群组中的每一个人，从而实现协同绘画</p>
</blockquote>
<p><img src="/2021/06/08/What-s-new-in-WWDC21/33.png" alt="截屏2021-06-09 上午8.38.07"></p>
</li>
</ul>
<p>小结：只需要让APP实现Group Activities，就可以实现基于FaceTime的共享体验</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/07/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/07/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/" class="post-title-link" itemprop="url">汇编语言学习笔记（五）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-06-07 08:55:01 / Modified: 21:38:25" itemprop="dateCreated datePublished" datetime="2021-06-07T08:55:01+08:00">2021-06-07</time>
            </span>

          
            <span id="/2021/06/07/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="汇编语言学习笔记（五）" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/07/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/07/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="3-4-mov-、add、sub指令"><a href="#3-4-mov-、add、sub指令" class="headerlink" title="3.4 mov 、add、sub指令"></a>3.4 mov 、add、sub指令</h1><ul>
<li>已学mov指令的几种形式<ul>
<li><code>mov 寄存器，数据</code>  mov ax, 6</li>
<li><code>mov 寄存器，寄存器 </code> mov bx, ax</li>
<li><code>mov 寄存器，内存单元</code> mov ax, [0]</li>
<li><code>mov 内存单元，寄存器</code> mov [0], ax</li>
<li><code>mov 段寄存器，寄存器</code> mov ds, ax</li>
</ul>
</li>
</ul>
<p><img src="/2021/06/07/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/1.png" alt="截屏2021-06-07 下午9.29.16"></p>
<h1 id="3-5-数据段"><a href="#3-5-数据段" class="headerlink" title="3.5 数据段"></a>3.5 数据段</h1><p>我们可以将一组长度为N(N &lt;= 64)、地址连续、起始地址为16的倍数的内存单元当作专门存放数据的内存空间，从而定义了一个数据段。</p>
<p>比如我们用123B0H~123B9H这段空间来存放数据：</p>
<ul>
<li>段地址：123BH</li>
<li>长度：10字节</li>
</ul>
<blockquote>
<p>问题3.5 </p>
<p>写几条指令，累加数据段中的前3个字型数据</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov ax, 123BH</span><br><span class="line">mov ds, ax</span><br><span class="line">mov ax, [0]  </span><br><span class="line">add ax, [2]   ;将数据段第二个字（偏移量为2）</span><br><span class="line">add ax [4]    ;将数据段第二个字（偏移量为4）</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/06/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/06/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/" class="post-title-link" itemprop="url">C++ Primer学习笔记（五）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-06-06 17:42:35 / Modified: 22:36:07" itemprop="dateCreated datePublished" datetime="2021-06-06T17:42:35+08:00">2021-06-06</time>
            </span>

          
            <span id="/2021/06/06/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="C++ Primer学习笔记（五）" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/06/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/06/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h1><ul>
<li><p>定义一个结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Sales_data</span> &#123;</span> </span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> bookNo; </span><br><span class="line">	<span class="keyword">unsigned</span> units_sold = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">double</span> revenue = <span class="number">0.0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义结构对象</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Sales_data</span> &#123;</span> <span class="comment">/* ... */</span> &#125; accum, trans, *salesptr; </span><br><span class="line"><span class="comment">// equivalent, but better way to define these objects</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Sales_data</span> &#123;</span> <span class="comment">/* ... */</span> &#125;; </span><br><span class="line">Sales_data accum, trans, *salesptr;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>定义结构体以分号结束</p>
</blockquote>
</li>
</ul>
<h2 id="include"><a href="#include" class="headerlink" title="#include"></a>#include</h2><p>预处理器是一个在编译器之前运行的程序，并且会改变我们程序的源码。</p>
<p>当预处理看到一个<code>#include</code>，会将指定头文件的内容替换掉<code>#include</code>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SALES_DATA_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SALES_DATA_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt; </span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Sales_data</span> &#123;</span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> bookNo;</span><br><span class="line">  <span class="keyword">unsigned</span> units_sold = <span class="number">0</span>; </span><br><span class="line">  <span class="keyword">double</span> revenue = <span class="number">0.0</span>;</span><br><span class="line">&#125;; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用#ifndef来防止头文件被多次引用</p>
</blockquote>
<h1 id="using-declaration"><a href="#using-declaration" class="headerlink" title="using declaration"></a>using declaration</h1><p>通过使用<code>using</code>形式的定义，来简化写法，比如：<code>using namespace::name</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="comment">// using declaration; when we use the name cin, we get the one from the namespace std</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cin</span>; </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; i; <span class="comment">// ok: cin is a synonym for std::cin</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; i; <span class="comment">// error: no using declaration; we must use the full name</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; i; <span class="comment">// ok: explicitly use cout from namepsace std</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>由于定义了<code>using std::cin</code>，我们可以在调用<code>cin</code>函数时，不添加<code>std::</code>namespace前缀。</p>
</blockquote>
<h1 id="String"><a href="#String" class="headerlink" title="String"></a>String</h1><ul>
<li><p>在使用string之前需要引入string头文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="定义和初始化"><a href="#定义和初始化" class="headerlink" title="定义和初始化"></a>定义和初始化</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s1; <span class="comment">// default initialization; s1 is the empty string </span></span><br><span class="line"><span class="built_in">string</span> s2 = s1; <span class="comment">// s2 isacopyof s1</span></span><br><span class="line"><span class="built_in">string</span> s3 = <span class="string">&quot;hiya&quot;</span>; <span class="comment">// s3 is a copy of the string literal</span></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">s4</span><span class="params">(<span class="number">10</span>, <span class="string">&#x27;c&#x27;</span>)</span></span>; <span class="comment">// s4 is cccccccccc</span></span><br></pre></td></tr></table></figure>

<h2 id="复制初始化（copy-initialize）和直接初始化-direct-initialization"><a href="#复制初始化（copy-initialize）和直接初始化-direct-initialization" class="headerlink" title="复制初始化（copy initialize）和直接初始化(direct initialization)"></a>复制初始化（copy initialize）和直接初始化(direct initialization)</h2><p>当使用<code>=</code>时，编译器是复制初始化，而当忽略<code>=</code>时，我们使用的是直接初始化，比如：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s5 = <span class="string">&quot;hiya&quot;</span>; <span class="comment">// copy initialization</span></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">s6</span><span class="params">(<span class="string">&quot;hiya&quot;</span>)</span></span>; <span class="comment">// direct initialization</span></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">s7</span><span class="params">(<span class="number">10</span>, <span class="string">&#x27;c&#x27;</span>)</span></span>; <span class="comment">// direct initialization; s7 is cccccccccc</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> s8 = <span class="built_in">string</span>(<span class="number">10</span>, <span class="string">&#x27;c&#x27;</span>); <span class="comment">// copy initialization; s8 is cccccccccc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">string</span> <span class="title">temp</span><span class="params">(<span class="number">10</span>, <span class="string">&#x27;c&#x27;</span>)</span></span>; <span class="comment">// temp is cccccccccc </span></span><br><span class="line"><span class="built_in">string</span> s8 = temp; <span class="comment">// copy temp into s8</span></span><br></pre></td></tr></table></figure>

<h2 id="读写字符串"><a href="#读写字符串" class="headerlink" title="读写字符串"></a>读写字符串</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Note: #include and using declarations must be added to compile this code int main()</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">string</span> s; <span class="comment">// empty string</span></span><br><span class="line"><span class="built_in">cin</span> &gt;&gt; s; <span class="comment">// read a whitespace-separated string into s</span></span><br><span class="line"><span class="built_in">cout</span> &lt;&lt; s &lt;&lt; <span class="built_in">endl</span>; <span class="comment">// write s to the output</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取字符串的长度"><a href="#获取字符串的长度" class="headerlink" title="获取字符串的长度"></a>获取字符串的长度</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> len = line.size(); <span class="comment">// len has type string::size_type</span></span><br></pre></td></tr></table></figure>

<h2 id="拼接字符串"><a href="#拼接字符串" class="headerlink" title="拼接字符串"></a>拼接字符串</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s1 = <span class="string">&quot;hello, &quot;</span>, s2 = <span class="string">&quot;world\n&quot;</span>;</span><br><span class="line"><span class="built_in">string</span> s3 = s1 + s2; <span class="comment">// s3 is hello, world\n</span></span><br><span class="line">s1+=s2; <span class="comment">// equivalentto s1=s1+s2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s1 = <span class="string">&quot;hello&quot;</span>, s2 = <span class="string">&quot;world&quot;</span>; <span class="comment">// no punctuation in s1 or s2</span></span><br><span class="line"><span class="built_in">string</span> s3 = s1 + <span class="string">&quot;, &quot;</span> + s2 + <span class="string">&#x27;\n&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意<code>+</code>符号两边至少要有一个string类型，不能是字符字面量相加</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s4 = s1 + <span class="string">&quot;, &quot;</span>; <span class="comment">// ok: adding a string and a literal string </span></span><br><span class="line">s5 = <span class="string">&quot;hello&quot;</span> + <span class="string">&quot;, &quot;</span>; <span class="comment">// error: no string operand string</span></span><br><span class="line">s6 = s1 + <span class="string">&quot;, &quot;</span> + <span class="string">&quot;world&quot;</span>; <span class="comment">// ok: each + has a string operand string </span></span><br><span class="line">s7 = <span class="string">&quot;hello&quot;</span> + <span class="string">&quot;, &quot;</span> + s2; <span class="comment">// error: can&#x27;t add string literals</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s6 = (s1 + <span class="string">&quot;, &quot;</span>) + <span class="string">&quot;world&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>相当于：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> tmp = s1 + <span class="string">&quot;, &quot;</span>; <span class="comment">// ok: + has a string operand</span></span><br><span class="line">s6 = tmp + <span class="string">&quot;world&quot;</span>; <span class="comment">// ok: + has a string operand</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">string</span> s7 = (<span class="string">&quot;hello&quot;</span> + <span class="string">&quot;, &quot;</span>) + s2; <span class="comment">// error: can&#x27;t add string literals</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>(“hello” + “,”) 符号两边都是常量</p>
</blockquote>
<blockquote>
<p><strong>Exercise 3.3:</strong> Explain how whitespace characters are handled in the string input operator and in the getline function.</p>
<p><strong>对于string类的输入函数，它会自动忽略开头的空白（空格、制表符、换行等等），从第一个真正的字符开始直到下一个空白。</strong></p>
<p><strong>对于getline()函数，它会保存字符串中的空白符，它读入数据，直到遇到换行符位置。</strong> </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">string</span> line;</span><br><span class="line">	<span class="comment">// read input a line at a time until end-of-file </span></span><br><span class="line">	<span class="keyword">while</span> (getline(<span class="built_in">cin</span>, line))</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; line &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>答案来自☞<a target="_blank" rel="noopener" href="https://blog.csdn.net/misayaaaaa/article/details/53284630">C++Primer第五版 第三章习题答案（1~10）</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/05/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/05/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/" class="post-title-link" itemprop="url">C++ Primer学习笔记（四）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-06-05 13:08:41 / Modified: 22:58:14" itemprop="dateCreated datePublished" datetime="2021-06-05T13:08:41+08:00">2021-06-05</time>
            </span>

          
            <span id="/2021/06/05/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="C++ Primer学习笔记（四）" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/05/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/05/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="decltype"><a href="#decltype" class="headerlink" title="decltype"></a>decltype</h1><blockquote>
<p>有时我们想将某一个表达式的结果的类型作为变量的类型</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decltype(f()) sum &#x3D; x; &#x2F;&#x2F; sum has whatever type f returns.</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> ci = <span class="number">0</span>, &amp;cj = ci;</span><br><span class="line"><span class="keyword">decltype</span>(ci) x = <span class="number">0</span>; <span class="comment">// x has type const int</span></span><br><span class="line"><span class="keyword">decltype</span>(cj) y = x; <span class="comment">// y has type const int&amp; and is bound to x </span></span><br><span class="line"><span class="keyword">decltype</span>(cj) z; <span class="comment">// error: z is a reference and must be initialized</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// decltype of an expression can be a reference type</span></span><br><span class="line"><span class="keyword">int</span> i = <span class="number">42</span>, *p = &amp;i, &amp;r = i;</span><br><span class="line"><span class="keyword">decltype</span>(r + <span class="number">0</span>) b; <span class="comment">// ok: addition yields an int; b is an (uninitialized) int </span></span><br><span class="line"><span class="keyword">decltype</span>(*p) c; <span class="comment">// error: c is int&amp; and must be initialized</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>decltype(*p)代表引用类型</p>
</blockquote>
<ul>
<li><p><code>decltype(())</code>：仅代表引用类型</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">decltype</span>((i)) d; <span class="comment">// error: d is int&amp; and must be initialized</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p><strong>Exercises Section 2.5.3<br> Exercise 2.36:</strong> In the following code, determine the type of each variable and the value each variable has when the code finishes:</p>
<p>int a = 3, b = 4; </p>
<p>decltype(a) c = a; </p>
<p>decltype((b)) d = a; </p>
<p>++c;</p>
<p>++d;</p>
<p>答：c : int， d int &amp;</p>
</blockquote>
<blockquote>
<p><strong>Exercise 2.37:</strong> <strong>Assignment is an example of an expression that yields a reference type. The type is a reference to the type of the left-hand operand. That is, if i is an int, then the type of the expression i = x is int&amp;.</strong> Using that knowledge, determine the type and value of each variable in this code:</p>
<p>int a = 3, b = 4;</p>
<p>decltype(a) c = a;</p>
<p>decltype(a = b) d = a; </p>
<p> 答：c : int ; d : int &amp; </p>
</blockquote>
<blockquote>
<p><strong>Exercise 2.38:</strong> Describe the differences in type deduction between decltype and auto. Give an example of an expression where auto and decltype will deduce the same type and an example where they will deduce differing types.</p>
<p>答：针对引用类型，如下： a是int类型，b是int &amp;</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">0</span>, &amp;r = i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> a = r;</span><br><span class="line"></span><br><span class="line"><span class="keyword">decltype</span>(r) b = i;</span><br></pre></td></tr></table></figure>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/" class="post-title-link" itemprop="url">汇编语言学习笔记（四）—— Debug</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-06-04 00:53:08 / Modified: 08:11:44" itemprop="dateCreated datePublished" datetime="2021-06-04T00:53:08+08:00">2021-06-04</time>
            </span>

          
            <span id="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/" class="post-meta-item leancloud_visitors" data-flag-title="汇编语言学习笔记（四）—— Debug" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="实验一"><a href="#实验一" class="headerlink" title="实验一"></a>实验一</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ul>
<li><p>下载并安装DosBox</p>
<p>到官网下载对应操作系统的软件 → <a target="_blank" rel="noopener" href="https://www.dosbox.com/download.php?main=1">传送门</a></p>
</li>
<li><p>下载Debug程序 →<a href="%5Bhttps://pan.baidu.com/s/1rzWTW1G76SdD7nGYs8WNaQ%5D(https://link.jianshu.com/?t=https://pan.baidu.com/s/1rzWTW1G76SdD7nGYs8WNaQ)">软件地址</a>来源自<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/147be16882e9?utm_campaign=maleskine&utm_content=note&utm_medium=seo_notes&utm_source=recommendation">Mac下的OS X系统如何使用Debug程序</a></p>
</li>
<li><p>运行DosBox后输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount c &#x2F;Users&#x2F;Leoolin&#x2F;Downloads</span><br></pre></td></tr></table></figure>

<blockquote>
<p>后面的路径为debug程序所在的文件夹</p>
</blockquote>
</li>
<li><p>再输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c:</span><br></pre></td></tr></table></figure>
</li>
<li><p>再输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug </span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="DEBUG常用命令"><a href="#DEBUG常用命令" class="headerlink" title="DEBUG常用命令"></a>DEBUG常用命令</h2><p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/1.png" alt="截屏2021-06-04 上午12.58.45"></p>
<ul>
<li><p>修改寄存器的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r ax</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/2.png" alt="截屏2021-06-04 上午7.38.28"></p>
</li>
<li><p>查看当前寄存器的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/3.png" alt="截屏2021-06-04 上午7.39.48"></p>
</li>
<li><p>执行一条指令</p>
<ul>
<li><p>修改代码段寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r cs</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改指令指针寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r ip</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<p>输入以下指令：</p>
<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/4.png" alt="截屏2021-06-04 上午7.55.53"></p>
<ul>
<li><p>查看内存中的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d</span><br></pre></td></tr></table></figure>

<ul>
<li><p>指定内存位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d 073F:0100</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/5.png" alt="截屏2021-06-04 上午7.58.37"></p>
</li>
</ul>
</li>
<li><p>将内存中的机器指令翻译成汇编指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u 073F:0100</span><br></pre></td></tr></table></figure>

<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/6.png" alt="截屏2021-06-04 上午8.00.15"></p>
<p>依次执行这些指令观察寄存器的变化：</p>
</li>
<li><p>修改代码段寄存器和指令指针寄存器的位置</p>
<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/7.png" alt="截屏2021-06-04 上午8.06.55"></p>
</li>
<li><p>依次执行…</p>
<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%E2%80%94%E2%80%94-Debug/8.png" alt="截屏2021-06-04 上午8.07.44"></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/" class="post-title-link" itemprop="url">汇编语言学习笔记（三）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-04 00:36:05" itemprop="dateCreated datePublished" datetime="2021-06-04T00:36:05+08:00">2021-06-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-06-07 21:22:48" itemprop="dateModified" datetime="2021-06-07T21:22:48+08:00">2021-06-07</time>
              </span>

          
            <span id="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="汇编语言学习笔记（三）" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="第三章-寄存器（内存访问）"><a href="#第三章-寄存器（内存访问）" class="headerlink" title="第三章 寄存器（内存访问）"></a>第三章 寄存器（内存访问）</h1><h2 id="3-1-内存中字的存储"><a href="#3-1-内存中字的存储" class="headerlink" title="3.1 内存中字的存储"></a>3.1 内存中字的存储</h2><p> 在0地址处开始存放20000（4E20H）：</p>
<p><img src="/2021/06/04/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/1.png" alt="截屏2021-06-04 上午12.10.10"></p>
<p>小端模式：高字节存放高地址位，低字节存放低地址位（0号单元是低地址单元，1号单元是高地址单元）</p>
<blockquote>
<p>问：1地址单元存放的字型数据是多少？</p>
<p>答：124EH</p>
</blockquote>
<p> 结论：任何两个地址连续的内存单元，N号单元和N+1号单元，可以将它们看成两个内存单元，也可以看成一个地址为N的字单元中的高位字节单元和低位字节单元。</p>
<h2 id="3-2-DS和-address"><a href="#3-2-DS和-address" class="headerlink" title="3.2 DS和[address]"></a>3.2 DS和[address]</h2><ul>
<li>CPU要读取一个内存单元的时候，必须先给出这个内存单元的地址</li>
<li>在8086PC中，内存地址由段地址和偏移地址组成</li>
<li>8086CPU中有一个DS寄存器，通常用来存放要访问的数据的段地址</li>
</ul>
<blockquote>
<p>例如：我们要读取10000H单元的内容可以用如下程序段进行：</p>
<p>mov bx, 1000H</p>
<p>mov ds, bx</p>
<p>mov al, [0]</p>
<p>上面三条指令将10000H(1000:0)中的数据读到al中</p>
</blockquote>
<p>mov指令的功能</p>
<ol>
<li><p>将数据直接送入寄存器</p>
<p>mov ax,2</p>
</li>
<li><p>将一个寄存器中的内容送入另一个寄存器</p>
<p>mov bx,ax</p>
</li>
<li><p>将一个内存单元中的内容送入另一个寄存器</p>
<p>mov al, [0]</p>
<ul>
<li>格式：mov 寄存器名, 内存单元地址</li>
<li>[…]表示一个内存单元，[…]中的0表示内存单元的偏移地址。</li>
<li>执行指令时，8086CPU自动取DS中的数据为内存单元的段。</li>
</ul>
</li>
</ol>
<blockquote>
<p>注意：8086CPU不支持将数据直接送入段寄存器 (由于硬件设计问题)</p>
<p>mov ds, 1000H是非法的 ❌</p>
<p>正确做法：数据-&gt;通用寄存器-&gt;段寄存器 ✅</p>
</blockquote>
<p>怎样将数据从寄存器al送入内存单元10000H？（反向操作~）</p>
<blockquote>
<p>mov bx, 1000H</p>
<p>mov ds, bx</p>
<p>mov [0] al</p>
</blockquote>
<h2 id="3-3-字的传送"><a href="#3-3-字的传送" class="headerlink" title="3.3 字的传送"></a>3.3 字的传送</h2><p>因为8086CPU是16位结构，有16根数据线，所以，可以一次性传送16位的数据，也就是一次性传送一个字。</p>
<blockquote>
<p>比如：</p>
<p>mov bx 1000H</p>
<p>mov ds, bx</p>
<p>mov ax, [0]   ;1000:0处的字型数据送入ax</p>
<p>mov [0], cx  ; cx中的16位数据送到1000:0处</p>
</blockquote>
<h2 id="问题3-3"><a href="#问题3-3" class="headerlink" title="问题3.3"></a>问题3.3</h2><blockquote>
<p>TODO: P14</p>
</blockquote>
<h2 id="问题3-4"><a href="#问题3-4" class="headerlink" title="问题3.4"></a>问题3.4</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/03/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="林辰">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Leoolin">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/03/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/" class="post-title-link" itemprop="url">C++ Primer学习笔记（三）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-06-03 15:37:48 / Modified: 23:32:37" itemprop="dateCreated datePublished" datetime="2021-06-03T15:37:48+08:00">2021-06-03</time>
            </span>

          
            <span id="/2021/06/03/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="C++ Primer学习笔记（三）" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/06/03/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/03/C-Primer%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="别名（Type-Aliases）"><a href="#别名（Type-Aliases）" class="headerlink" title="别名（Type Aliases）"></a>别名（Type Aliases）</h1><ul>
<li>写法一</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> wages; <span class="comment">// wages is a synonym for double</span></span><br><span class="line"><span class="keyword">typedef</span> wages base, *p; <span class="comment">// base is a synonym for double, p for double*</span></span><br><span class="line"></span><br><span class="line">wages i = <span class="number">1.0</span>;</span><br><span class="line">p val = &amp;i;</span><br></pre></td></tr></table></figure>

<ul>
<li>写法二</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> SI = <span class="keyword">int</span>; <span class="comment">// SI is a synonym for int</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>C++11支持</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">char</span> *pstring;</span><br><span class="line"><span class="keyword">const</span> pstring cstr = <span class="number">0</span>; <span class="comment">// cstr is a constant pointer to char</span></span><br><span class="line"><span class="keyword">const</span> pstring *ps; <span class="comment">// ps is a pointer to a constant pointer to char</span></span><br></pre></td></tr></table></figure>

<h1 id="auto类型"><a href="#auto类型" class="headerlink" title="auto类型"></a>auto类型</h1><blockquote>
<p>编译器会自动通过初试值来判断<code>auto</code>对象的类型</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">autoi=<span class="number">0</span>,*p=&amp;i; <span class="comment">//ok: i is int and p isapointerto </span></span><br><span class="line"><span class="keyword">int</span> <span class="keyword">auto</span> sz = <span class="number">0</span>, pi = <span class="number">3.14</span>; <span class="comment">// error: inconsistent types for sz and pi</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>auto会自动忽略top-level const，保留low-level const</p>
<blockquote>
<p>top-level const即自身为常量</p>
<p>low-level const即自身可以修改，但是所指向（引用）的地址储存值为常量</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> ci = i, &amp;cr = ci;</span><br><span class="line"><span class="keyword">auto</span> b = ci; <span class="comment">// b is an int (top-level const in ci is dropped)</span></span><br><span class="line"><span class="keyword">auto</span> c = cr; <span class="comment">// c is an int (cr is an alias for ci whose const is top-level) autod=&amp;i; // d isan int*(&amp; ofan int objectis int*)</span></span><br><span class="line"><span class="keyword">auto</span> e = &amp;ci; <span class="comment">// e is const int*(&amp; of a const object is low-level const)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置为top-level const</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">auto</span> f = ci; <span class="comment">// deduced type of ci is int; f has type const int</span></span><br></pre></td></tr></table></figure>















































</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">林辰</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">林辰</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'kFJQFYlGcpqkKj9grbxdFeO3-gzGzoHsz',
      appKey     : 'cKBWWrkyrqclSn3x0gcqCNST',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
